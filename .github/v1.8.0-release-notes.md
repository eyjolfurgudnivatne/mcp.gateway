# üéâ MCP Gateway v1.8.0 Release Notes

**Release Date:** 20. desember 2025  
**Branch:** feat/v1.8.0-enhancements  
**Status:** üéâ **READY FOR RELEASE!** üéâ

---

## üéä Executive Summary

**MCP Gateway v1.8.0** focuses on **developer experience**, **production monitoring**, and **optional MCP 2025-11-25 features**!

This release adds:
- ‚úÖ Tool Lifecycle Hooks - Monitor and track tool invocations
- ‚úÖ Resource Subscriptions - Optional MCP 2025-11-25 feature
- ‚úÖ Better Error Messages - Helpful suggestions and schema hints
- ‚úÖ Authorization Support - Role-based access control example
- ‚úÖ **Zero breaking changes** - 100% backward compatible!

**Implementation stats:**
- **Time:** ~10 hours (vs 30-44 hours estimated)
- **Efficiency:** **3.7x faster than estimated!** üöÄ
- **Tests:** 273/273 passing (20 new tests)
- **Documentation:** 2000+ new lines

---

## üöÄ What's New in v1.8.0

### Phase 1: Documentation & Examples (15 min)

#### Session Management Guide
Complete guide to MCP session management:

**File:** `Examples/NotificationMcpServer/SESSION_MANAGEMENT.md`

**Topics:**
- Session creation and validation
- Session timeout handling
- Best practices for production
- Code examples

#### Migration Guide
Step-by-step guide from v1.6.x to v1.7.0:

**File:** `MIGRATION_GUIDE_v1.7.0.md`

**Topics:**
- Backward compatibility guarantees
- Optional migration steps
- Code examples for all scenarios

---

### Phase 2: Better Error Messages (1 hour)

#### 1. Tool Not Found Suggestions
When a tool is not found, server suggests similar tool names:

```json
{
  "error": {
    "code": -32601,
    "message": "Method not found",
    "data": {
      "detail": "Function 'add_number' is not configured.",
      "requestedTool": "add_number",
      "suggestions": ["add_numbers", "add_numbers_typed"],
      "hint": "Did you mean: add_numbers, add_numbers_typed?"
    }
  }
}
```

**Features:**
- Levenshtein distance algorithm
- Suggests up to 3 similar tool names
- Max edit distance: 3
- Fast O(n) search

#### 2. Invalid Parameters Schema Hints
When parameters are invalid, server shows expected schema:

```json
{
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": {
      "detail": "Parameters 'number1' and 'number2' are required",
      "tool": "add_numbers",
      "requiredFields": ["number1", "number2"],
      "example": "{ \"number1\": 42, \"number2\": 42 }",
      "hint": "Required fields: number1, number2"
    }
  }
}
```

**Features:**
- Extracts required fields from schema
- Builds example JSON with all required parameters
- Clear, actionable error messages

#### 3. Session Expired Guidance
When session expires, server provides clear guidance:

```json
{
  "error": {
    "code": -32001,
    "message": "Session not found or expired",
    "data": {
      "sessionId": "abc123",
      "hint": "Please re-initialize with POST /mcp",
      "timeoutMinutes": 30
    }
  }
}
```

**Features:**
- Clear re-initialization guidance
- Session timeout information
- Actionable error messages

---

### Phase 3: Tool Lifecycle Hooks (5.5 hours)

Monitor and track tool invocations with **Lifecycle Hooks** - perfect for metrics, logging, authorization, and production monitoring!

#### IToolLifecycleHook Interface

```csharp
public interface IToolLifecycleHook
{
    Task OnToolInvokingAsync(string toolName, JsonRpcMessage request);
    Task OnToolCompletedAsync(string toolName, JsonRpcMessage response, TimeSpan duration);
    Task OnToolFailedAsync(string toolName, Exception error, TimeSpan duration);
}
```

**Features:**
- Fire-and-forget pattern (hooks should not throw)
- Exception-safe execution (errors logged, not propagated)
- Multiple hooks supported

#### Built-in Hooks

**LoggingToolLifecycleHook** - Simple logging integration:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.AddToolsService();
builder.AddToolLifecycleHook<LoggingToolLifecycleHook>();  // Log all invocations

var app = builder.Build();
```

**MetricsToolLifecycleHook** - In-memory metrics tracking:

```csharp
builder.AddToolLifecycleHook<MetricsToolLifecycleHook>();

// Expose metrics via HTTP endpoint
app.MapGet("/metrics", (IEnumerable<IToolLifecycleHook> hooks) =>
{
    var metricsHook = hooks.OfType<MetricsToolLifecycleHook>().FirstOrDefault();
    var metrics = metricsHook?.GetMetrics();
    
    return Results.Json(new
    {
        timestamp = DateTime.UtcNow,
        metrics = metrics?.Select(kvp => new
        {
            tool = kvp.Key,
            invocations = kvp.Value.InvocationCount,
            successes = kvp.Value.SuccessCount,
            failures = kvp.Value.FailureCount,
            successRate = Math.Round(kvp.Value.SuccessRate * 100, 2),
            avgDuration = Math.Round(kvp.Value.AverageDuration.TotalMilliseconds, 2)
        })
    });
});
```

**Tracked Metrics:**
- Invocation count (total, success, failure)
- Success rate (percentage)
- Duration (min, max, average)
- Error types (count by exception type)

#### Authorization Support

Implement role-based authorization using lifecycle hooks:

```csharp
using Mcp.Gateway.Tools.Lifecycle;

[AttributeUsage(AttributeTargets.Method, AllowMultiple = true)]
public class RequireRoleAttribute : Attribute
{
    public string Role { get; }
    public RequireRoleAttribute(string role) => Role = role;
}

public class AuthorizationHook : IToolLifecycleHook
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    
    public Task OnToolInvokingAsync(string toolName, JsonRpcMessage request)
    {
        var httpContext = _httpContextAccessor.HttpContext;
        var requiredRoles = GetRequiredRoles(toolName);
        var userRoles = httpContext?.Items["UserRoles"] as List<string>;
        
        if (!HasRequiredRole(requiredRoles, userRoles))
        {
            throw new ToolInvalidParamsException(
                $"Insufficient permissions to invoke '{toolName}'.",
                toolName);
        }
        
        return Task.CompletedTask;
    }
    
    // ... other methods
}

// Usage on tools:
[McpTool("delete_user")]
[RequireRole("Admin")]
public JsonRpcMessage DeleteUser(JsonRpcMessage request) { /* ... */ }

// Register authorization hook:
builder.AddToolLifecycleHook<AuthorizationHook>();
```

**Features:**
- Declarative role requirements via attributes
- Integration with ASP.NET Core authentication
- Custom authorization logic via hooks
- 1200+ lines of documentation

#### Examples

**MetricsMcpServer** - Lifecycle hooks with `/metrics` endpoint:
- Calculator tools (add, divide, slow_operation)
- `/metrics` endpoint for metrics reporting
- 4 integration tests

**AuthorizationMcpServer** - Role-based authorization:
- User management tools with role requirements
- Authorization middleware and hooks
- 8 integration tests covering all scenarios

---

### Phase 4: Resource Subscriptions (3.5 hours)

Subscribe to specific resources for targeted notifications - reduces bandwidth and improves performance for high-frequency updates!

#### API Overview

**Subscribe to a resource:**

```bash
# POST /mcp to subscribe (creates session automatically)
curl -X POST http://localhost:5000/mcp \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2025-11-25" \
  -d '{
    "jsonrpc": "2.0",
    "method": "resources/subscribe",
    "params": {
      "uri": "file://data/users.json"
    },
    "id": 1
  }'

# Response:
{
  "jsonrpc": "2.0",
  "result": {
    "subscribed": true,
    "uri": "file://data/users.json"
  },
  "id": 1
}
```

**Unsubscribe from a resource:**

```bash
curl -X POST http://localhost:5000/mcp \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2025-11-25" \
  -H "MCP-Session-Id: <your-session-id>" \
  -d '{
    "jsonrpc": "2.0",
    "method": "resources/unsubscribe",
    "params": {
      "uri": "file://data/users.json"
    },
    "id": 2
  }'
```

**Filtered notifications:**

When a resource changes, only subscribed sessions receive notifications:

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/resources/updated",
  "params": {
    "uri": "file://data/users.json"
  }
}
```

#### Features

- ‚úÖ **Exact URI matching** - Subscribe to specific resources only (no wildcards in v1.8.0)
- ‚úÖ **Session-based** - Subscriptions tied to MCP sessions
- ‚úÖ **Automatic cleanup** - Subscriptions cleared on session expiry/deletion
- ‚úÖ **Notification filtering** - Server only sends to subscribed sessions
- ‚úÖ **Requires session management** - Must use `/mcp` endpoint with `MCP-Session-Id`

#### When to Use Subscriptions

**‚úÖ Good use cases:**
- High-frequency resource updates (e.g., live metrics)
- Many resources, few clients interested in each
- Reducing notification bandwidth

**‚ùå When NOT to use:**
- Low-frequency updates (subscriptions add complexity)
- All clients need all notifications (just broadcast)
- Simple request-response patterns (use tools instead)

#### Example

**ResourceMcpServer** - Resource subscriptions demo:
- File, system, and database resources
- Subscribe/unsubscribe workflow
- 7 integration tests
- Comprehensive README with examples

---

## üìö Documentation

### New Documentation
- ‚úÖ `docs/LifecycleHooks.md` - Complete API reference for lifecycle hooks
- ‚úÖ `docs/Authorization.md` - Authorization patterns and best practices (1200+ lines)
- ‚úÖ `docs/ResourceSubscriptions.md` - Resource subscription guide (670+ lines)
- ‚úÖ `Examples/ResourceMcpServer/README.md` - Subscription workflow (450+ lines)
- ‚úÖ `Examples/NotificationMcpServer/SESSION_MANAGEMENT.md` - Session management guide
- ‚úÖ `MIGRATION_GUIDE_v1.7.0.md` - Migration guide from v1.6.x

### Updated Documentation
- ‚úÖ `README.md` - Added sections for Lifecycle Hooks, Authorization, Resource Subscriptions
- ‚úÖ Updated Features list with v1.8.0 capabilities
- ‚úÖ Updated test count: 273 tests

---

## üîÑ Migration Guide

### From v1.7.x to v1.8.0

**Good news:** v1.8.0 is **100% backward compatible!** No breaking changes.

#### No Code Changes Required

All v1.7.x code continues to work unchanged:

```csharp
// v1.7.x code (still works!)
app.UseProtocolVersionValidation();
app.MapStreamableHttpEndpoint("/mcp");
```

#### Optional: Add Lifecycle Hooks

```csharp
// v1.8.0 - Add lifecycle hooks (optional)
builder.AddToolsService();
builder.AddToolLifecycleHook<LoggingToolLifecycleHook>();
builder.AddToolLifecycleHook<MetricsToolLifecycleHook>();

var app = builder.Build();
```

#### Optional: Use Resource Subscriptions

Resource subscriptions work automatically - no code changes needed on server side!

Clients can now use `resources/subscribe` and `resources/unsubscribe` methods.

---

## üì¶ Installation

### NuGet
```bash
dotnet add package Mcp.Gateway.Tools --version 1.8.0
```

### From source
```bash
git clone https://github.com/eyjolfurgudnivatne/mcp.gateway
cd mcp.gateway
git checkout v1.8.0
dotnet build
```

---

## üß™ Testing

**All 273 tests passing!** ‚úÖ

```bash
dotnet test
# Test summary: total: 273; failed: 0; succeeded: 273
```

### Test Coverage

| Component | Tests | Status |
|-----------|-------|--------|
| Core library (v1.7.x) | 253 | ‚úÖ All passing |
| Phase 3 (Lifecycle Hooks) | 12 | ‚úÖ All passing |
| Phase 4 (Resource Subscriptions) | 7 | ‚úÖ All passing |
| **Total** | **273** | ‚úÖ **All passing** |

---

## üéñÔ∏è Contributors

**Development Team:**
- ARKo AS - AHelse Development Team

**Special Thanks:**
- GitHub Copilot for amazing assistance throughout development
- MCP community for feedback and specification work

---

## üîÆ What's Next?

### Future Enhancements (v1.9.0+)

**Planned features:**
- Wildcard subscriptions: `file://logs/*.log`, `file://logs/**`
- Regex pattern matching for subscriptions
- Resource templates with URI variables
- Completion API (`completion/complete`)
- Logging support (client-to-server log forwarding)
- Performance optimizations

**Timeline:** No rush - focus on stability and community feedback first.

---

## üêõ Known Issues

### Limitations
- **Resource subscriptions** - Exact URI matching only (wildcards in v1.9.0)
- **Binary streaming** remains WebSocket-only (MCP spec doesn't support binary over SSE)

### Compatibility
- Fully backward compatible with v1.7.x
- All new features are opt-in
- Legacy code continues to work

---

## üìú License

MIT ¬© 2024‚Äì2025 ARKo AS ‚Äì AHelse Development Team

---

## üéâ Celebrate!

**v1.8.0 is another GREAT milestone!**

- üèÜ Tool Lifecycle Hooks (production-ready monitoring)
- üèÜ Resource Subscriptions (optional MCP 2025-11-25 feature)
- üèÜ Better Error Messages (improved developer experience)
- üèÜ Authorization Support (role-based access control)
- üèÜ 273 tests (all passing)
- üèÜ Zero breaking changes
- üèÜ 2000+ lines of documentation

**Thank you for using MCP Gateway!** üôè

---

**Release Date:** 20. desember 2025  
**Version:** 1.8.0  
**Protocol:** MCP 2025-11-25 Compliant  
**Status:** üéâ **READY FOR RELEASE!**
